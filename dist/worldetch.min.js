var worldetch=(()=>{var fe=Object.defineProperty;var ut=Object.getOwnPropertyDescriptor;var ht=Object.getOwnPropertyNames;var ft=Object.prototype.hasOwnProperty;var gt=(l,e,t)=>e in l?fe(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var xt=(l,e)=>{for(var t in e)fe(l,t,{get:e[t],enumerable:!0})},wt=(l,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of ht(e))!ft.call(l,a)&&a!==t&&fe(l,a,{get:()=>e[a],enumerable:!(i=ut(e,a))||i.enumerable});return l};var bt=l=>wt(fe({},"__esModule",{value:!0}),l);var n=(l,e,t)=>gt(l,typeof e!="symbol"?e+"":e,t);var kt={};xt(kt,{worldetch:()=>Tt});var ve=class{constructor(e){this.base=e;n(this,"points",[]);this._extract()}static from_aabb(e){return Z.area(e)}do(e){for(let t=0;t<this.points.length;t++)e(this.points[t])}_extract(){this.points=[];let e=0;for(let t=this.base.min[1];t<this.base.max[1];t++)for(let i=this.base.min[0];i<this.base.max[0];i++){let a=i===this.base.min[0]||i===this.base.max[0]-1||t===this.base.min[1]||t===this.base.max[1]-1,h=e++%2===1,f=t===this.base.min[1],b=i===this.base.max[0]-1,E=t===this.base.max[1]-1,y=i===this.base.min[0];this.points.push({pos:[i,t],isBorder:a,isNorth:f,isEast:b,isSouth:E,isWest:y})}}},le=ve;var Ke=window.glob||{};window.glob=Ke;var o=Ke;var ye=class l{static pt(e){return{x:e[0],y:e[1]}}static vec2s(e){return[String(e[0]),String(e[1])]}static area_every(e,t){let i=e.min[1];for(;i<=e.max[1];i++){let a=e.max[0];for(;a>=e.min[0];a--)t([a,i])}}static copy(e){return[e[0],e[1]]}static make(e,t){return[e,t]}static to_string(e){let t=i=>i!=null?`, ${i}`:"";return`${e[0]}, ${e[1]}`+t(e[2])+t(e[3])}static to_string_fixed(e){let t=i=>i!=null?`, ${i}`:"";return`${e[0].toFixed(1)}, ${e[1].toFixed(1)}`+t(e[2])+t(e[3])}static func(e,t){let i=e.min[1];for(;i<=e.max[1];i++){let a=e.max[0];for(;a>=e.min[0];a--)t([a,i])}}static project(e,t=o.hexsize){let i=t[0]-1,a=t[1]-1,h=e[0],f=-e[1],b=i*.75;return[(h-f)*b,(h+f)*(-a/2)]}static unproject(e){let t=o.hexsize[0]-1,i=o.hexsize[1]-1,a=t*.75,h=e[0]/a,f=-e[1]/(i/2),b=(h+f)/2,E=(h-f)/2;return[b,E]}static equals(e,t){return e[0]==t[0]&&e[1]==t[1]}static floor(e){return[Math.floor(e[0]),Math.floor(e[1])]}static ceil(e){return[Math.ceil(e[0]),Math.ceil(e[1])]}static round(e){return[Math.round(e[0]),Math.round(e[1])]}static inv(e){return[-e[0],-e[1]]}static mult(e,t,i){return[e[0]*t,e[1]*(i||t)]}static mults(e,t){return[e[0]*t[0],e[1]*t[1]]}static divide(e,t,i){return[e[0]/t,e[1]/(i||t)]}static divides(e,t){return[e[0]/t[0],e[1]/t[1]]}static subtract(e,t){return[e[0]-t[0],e[1]-t[1]]}static add(e,t){return[e[0]+t[0],e[1]+t[1]]}static addn(e,t){return[e[0]+t,e[1]+t]}static abs(e){return[Math.abs(e[0]),Math.abs(e[1])]}static min(e,t){return[Math.min(e[0],t[0]),Math.min(e[1],t[1])]}static max(e,t){return[Math.max(e[0],t[0]),Math.max(e[1],t[1])]}static _32(e){return[e[0],e[1]]}static together(e){return e[0]+e[1]}static make_uneven(e,t=-1){let i=l.copy(e);return i[0]%2!=1&&(i[0]+=t),i[1]%2!=1&&(i[1]+=t),i}static make_even(e,t=-1){let i=l.copy(e);return i[0]%2!=0&&(i[0]+=t),i[1]%2!=0&&(i[1]+=t),i}static angle(e,t){return-Math.atan2(e[0]-t[0],e[1]-t[1])}static dist(e,t){let i=t[0]-e[0],a=t[1]-e[1];return Math.sqrt(i*i+a*a)}static distsimple(e,t){let i=l.abs(l.subtract(e,t));return Math.max(i[0],i[1])}},s=ye;var Qe=(i=>(i[i.Outside=0]="Outside",i[i.Inside=1]="Inside",i[i.Overlap=2]="Overlap",i))(Qe||{}),ge=class ge{constructor(e,t){n(this,"min");n(this,"max");this.min=this.max=[...e],t&&this.extend(t)}static dupe(e){return new ge(e.min,e.max)}static area(e){return new le(e)}extend(e){this.min=s.min(this.min,e),this.max=s.max(this.max,e)}diagonal(){return s.subtract(this.max,this.min)}center(){return s.add(this.min,s.mult(this.diagonal(),.5))}translate(e){this.min=s.add(this.min,e),this.max=s.add(this.max,e)}test(e){return this.max[0]<e.min[0]||this.min[0]>e.max[0]||this.max[1]<e.min[1]||this.min[1]>e.max[1]?0:this.min[0]<=e.min[0]&&this.max[0]>=e.max[0]&&this.min[1]<=e.min[1]&&this.max[1]>=e.max[1]?1:2}};n(ge,"TEST",Qe);var Ee=ge,Z=Ee;var oe=class{static create(e){e in this.hooks||(this.hooks[e]=[])}static addListener(e,t){this.create(e),this.hooks[e].push(t)}static removeListener(e,t){this.hooks[e]=this.hooks[e].filter(i=>i!==t)}static placeListener(e,t,i){this.create(e),this.hooks[e][t]!==void 0&&console.error(`Error: Hook '${e}' already has a function registered at index ${t}`),this.hooks[e][t]=i}static async emit(e,t){return this._emitFast(e,t)}static async _emitFast(e,t){if(e in this.hooks){for(let i=this.hooks[e].length;i--;)if(await this.hooks[e][i]?.(t))return}}};n(oe,"hooks",{});var L=oe;var je;(S=>{S.TOGGLE_NORMAL_MAPS=!0,S.TOGGLE_TOP_DOWN_MODE=!1,S.TOGGLE_RENDER_AXES=!1;let i=Math.PI/6,a=Math.PI/6;async function h(){await k.init(),L.addListener("worldetchComponents",H),o.wallrotation=i,o.wallrotationstaggered=a,E()}S.init=h;function f(){E(),c.utilEraseChildren(c.groups.monolith)}S.purge=f;let b;function E(){let j=new THREE.BufferGeometry,u=new Float32Array([0,0,0,0,1,0]);j.setAttribute("position",new THREE.BufferAttribute(u,3));let d=new THREE.LineBasicMaterial({color:16711680});b=new THREE.Line(j,d)}function y(){let j=m(b.geometry,b,c.camera,c.renderer);o.pancompress=-1/j.y}function g(j,u,d){let T=j.clone().project(u),I=d.domElement.width/2,Q=d.domElement.height/2;return new THREE.Vector2(T.x*I+I,-T.y*Q+Q)}function m(j,u,d,T){let I=j.attributes.position;if(I.count<2)return console.error("Geometry does not have enough vertices."),null;let Q=new THREE.Vector3().fromBufferAttribute(I,0).applyMatrix4(u.matrixWorld),R=new THREE.Vector3().fromBufferAttribute(I,1).applyMatrix4(u.matrixWorld),N=g(Q,d,T),ee=g(R,d,T);return new THREE.Vector2().subVectors(ee,N)}async function H(){return c.scene.scale.set(o.scale,o.scale,o.scale),k.step(),U(),y(),!1}function U(){for(let j of P)j.update()}let k;(I=>{function j(){q()}I.step=j;async function u(){await d(),await T()}I.init=u;async function d(){await c.preloadTextureAsync("./img/textures/star.jpg"),await c.preloadTextureAsync("./img/textures/starnormal.jpg"),await c.preloadTextureAsync("./img/textures/japanese2.jpg"),await c.preloadTextureAsync("./img/textures/japanese3.jpg"),await c.preloadTextureAsync("./img/textures/japanese4.jpg"),await c.preloadTextureAsync("./img/textures/wall1.jpg"),await c.preloadTextureAsync("./img/textures/wall1normal.jpg"),await c.preloadTextureAsync("./img/textures/wall2.jpg"),await c.preloadTextureAsync("./img/textures/wall2normal.jpg"),await c.preloadTextureAsync("./img/textures/water.jpg"),await c.preloadTextureAsync("./img/textures/overgrown_x.jpg"),await c.preloadTextureAsync("./img/textures/stonemixed.jpg"),await c.preloadTextureAsync("./img/textures/stonemixednormal.jpg"),await c.preloadTextureAsync("./img/textures/stonemixed2.jpg"),await c.preloadTextureAsync("./img/textures/stonemixed2normal.jpg"),await c.preloadTextureAsync("./img/textures/cobblestone3.jpg"),await c.preloadTextureAsync("./img/textures/cobblestone3normal.jpg"),await c.preloadTextureAsync("./img/textures/beach.jpg"),await c.preloadTextureAsync("./img/textures/beachnormal.jpg"),await c.preloadTextureAsync("./img/textures/sand.jpg"),await c.preloadTextureAsync("./img/textures/oop.jpg"),await c.preloadTextureAsync("./img/textures/cobblestone.jpg"),await c.preloadTextureAsync("./img/textures/cobblestone2.jpg"),await c.preloadTextureAsync("./img/textures/basaltcliffs.jpg"),await c.preloadTextureAsync("./img/textures/cliffs.jpg")}async function T(){let Q=new THREE.DirectionalLight("lavender",Math.PI/3);c.scene.add(Q),c.scene.add(Q.target)}})(k=S.stage||(S.stage={}));let P=[];class D{constructor(u){this.gobj=u;n(this,"entityGroup");n(this,"pos3d",[0,0]);n(this,"z",0);this.entityGroup=new THREE.Group,P.push(this)}_monolithAdd(){c.groups.monolith.add(this.entityGroup)}_monolithRemove(){this.entityGroup.parent.remove(this.entityGroup)}create(){this._create(),this._monolithAdd()}delete(){this.free(),this._delete(),this._monolithRemove()}step(){this._step(),this.translate()}update(){this._update()}free(){let u=P.indexOf(this);u!==-1&&P.splice(u,1)}_create(){console.warn("empty entity create")}_delete(){console.warn("empty entity delete")}_step(){}_update(){}translate(){let{wpos:u}=this.gobj,d=this.pos3d=s.project(u);d[1]=ie.roundToNearest(d[1],o.pancompress),this.entityGroup.position.fromArray([...d,this.z]),this.entityGroup.updateMatrix()}}class B extends D{constructor(d){super(d.gobj);this.data=d;this.data={shapeTexture:"./img/textures/cobblestone3.jpg",shapeTextureNormal:"./img/textures/stonemixednormal.jpg",shapeGroundTexture:"./img/textures/stonemixed2.jpg",shapeGroundTextureNormal:"./img/textures/stonemixed2normal.jpg",shapeGroundSpecular:"lavender",...d}}}S.shape3d=B;class C extends B{constructor(d){super(d);n(this,"hexTile")}_create(){this.hexTile=new x(this.data),this.entityGroup.add(this.hexTile.group),S.TOGGLE_RENDER_AXES&&this.entityGroup.add(new THREE.AxesHelper(12)),this.translate()}_delete(){this.hexTile.free()}}S.shape_hex_wrapper=C,S.hexscalar=7.1;class x{constructor(u){this.data=u;n(this,"scalar");n(this,"group");n(this,"mesh");this.scalar=S.hexscalar,this.make()}make(){let{scalar:u}=this,d=[1*u,0*u,0*u,.5*u,.866*u,0*u,-.5*u,.866*u,0*u,-1*u,0*u,0*u,-.5*u,-.866*u,0*u,.5*u,-.866*u,0*u],T=[1,0,0,.5,.866,0,-.5,.866,0,-1,0,0,-.5,-.866,0,.5,-.866,0],I=[0,1,2,0,2,3,0,3,4,0,4,5,0,5,6,0,6,1],Q=[.5,0,1,.5,.75,1,.25,1,0,.5,.25,0,.75,0],R=new THREE.BufferGeometry;R.setAttribute("position",new THREE.Float32BufferAttribute(d,3)),R.setAttribute("uv",new THREE.Float32BufferAttribute(Q,2)),R.setIndex(I);let N=[];for(let he=0;he<I.length;he+=3)N.push(0,0,1,0,0,1,0,0,1);R.setAttribute("normal",new THREE.Float32BufferAttribute(N,3));let ee=new THREE.MeshPhongMaterial({color:"white",specular:this.data.shapeGroundSpecular,shininess:7,normalScale:new THREE.Vector2(1,1),map:c.getTexture(this.data.shapeGroundTexture),normalMap:c.getTexture(this.data.shapeGroundTextureNormal)});S.TOGGLE_NORMAL_MAPS||(ee.normalMap=null),this.group=new THREE.Group,this.group.scale.set(1,1,1),this.mesh=new THREE.Mesh(R,ee),this.group.add(this.mesh)}free(){this.mesh.geometry.dispose(),this.mesh.material.dispose()}}function w(j,u){let d;switch(j){case"nothing":console.warn(" no shape type passed to factory ");break;case"hex":d=new C(u);break;case"wall":d=new _(u);break}return d}S.shapeMaker=w;class _ extends B{constructor(d){super(d);n(this,"stagger",!1);n(this,"rotationGroup");n(this,"wallGroup");n(this,"wallMaterial")}_create(){let{shapeSize:d}=this.data,T=new THREE.MeshPhongMaterial({map:c.getTexture(this.data.shapeTexture),normalMap:c.getTexture(this.data.shapeTextureNormal)});S.TOGGLE_NORMAL_MAPS||(T.normalMap=null),this.wallGroup=p(this,T),this.wallGroup.position.set(5,4,0),this.wallGroup.updateMatrix(),this.rotationGroup=new THREE.Group,this.rotationGroup.add(this.wallGroup),this.rotationGroup.position.z=d[2]/2,this.entityGroup.add(this.rotationGroup),S.TOGGLE_RENDER_AXES&&this.entityGroup.add(new THREE.AxesHelper(12)),this.translate(),this._step(),this.wallMaterial=T}dispose(){this.wallMaterial.dispose()}_delete(){this.dispose()}_step(){this.rotationGroup.rotation.set(0,0,o.wallrotation),this.rotationGroup.updateMatrix(),this.entityGroup.updateMatrix()}}S.shape_wall=_;function p(j,u){let{shapeSize:d}=j.data,T=d,I=new THREE.Group,R=j.data.gobj,N=R.wallAdapter,ee=R.data.extra.staggerData;if(!N){console.warn(" no direction adapter for wallmaker ");return}let he=($,J,qe)=>{let nt=N.get_all_objects_at(qe),ct=N.get_all_objects_at(J),lt=nt[0],pt=ct[0],Ye=s.project($.wpos),Ve=s.project(lt.wpos),Je=s.project(pt.wpos),dt=(Ve[0]+Je[0])/2-Ye[0],mt=(Ve[1]+Je[1])/2-Ye[1],_e=[dt,mt];return _e=s.round(_e),_e},r,A;if(N.tile_occupied("northwest")&&N.tile_occupied("east")){let $=he(R,"northwest","east");ee?.isNorth,$=s.add($,[-3,-4]),r=new THREE.BoxGeometry(T[0],T[1],T[2]),A=new THREE.Mesh(r,u),A.position.set($[0],$[1],0),A.rotation.set(0,0,Math.PI/2),A.updateMatrix(),I.add(A)}else if(N.tile_occupied("west")&&N.tile_occupied("southeast")){let $=[0,0];ee?.isNorth,$=s.add($,[-4,0]),r=new THREE.BoxGeometry(T[0]/2,T[1],T[2]),A=new THREE.Mesh(r,u),A.position.set($[0],$[1],0),A.rotation.set(0,0,Math.PI/2),A.updateMatrix(),I.add(A)}return N.tile_occupied("north")&&(r=new THREE.BoxGeometry(T[0],T[1],T[2]),A=new THREE.Mesh(r,u),I.add(A)),N.tile_occupied("south")&&(r=new THREE.BoxGeometry(T[0]/2,T[1],T[2]),A=new THREE.Mesh(r,u),A.position.set(-T[0]/4,0,0),A.updateMatrix(),I.add(A)),(N.tile_occupied("north")&&N.tile_occupied("east")||N.tile_occupied("east")&&N.tile_occupied("south")||N.tile_occupied("south")&&N.tile_occupied("west")||N.tile_occupied("west")&&N.tile_occupied("north"))&&(r=new THREE.BoxGeometry(T[0]/2,T[1]/2,T[2]),r.translate(-T[0]/4,T[1]/4,0)),I}class M extends B{constructor(d){super(d);n(this,"light")}_create(){}}S.shape_light_bad_idea=M;class Y extends D{constructor(d){super(d.gobj);this.data=d;n(this,"wpos2");n(this,"light");this.data={radiance:60,...d},this.wpos2=s.copy(this.gobj.wpos)}lyft(d){this.entityGroup.position.z+=1}_step(){}_update(){this.light.position.x=3,this.light.updateMatrix();let d=4;this.entityGroup.rotation.z+=Math.PI*2*(1/d*o.delta),this.entityGroup.updateMatrix(),this.light.updateMatrix(),o.reprerender=!0,o.dirtyobjects=!0}_delete(){console.log("remove light")}_create(){console.log(" tf light source create "),this.light=new THREE.PointLight("white",1,5),this.light.intensity=700*(o.scale*2),this.light.distance=600*(o.scale*2),this.light.decay=2.3,this.light.updateMatrix(),this.entityGroup.add(this.light),this.z=4,this.translate(),this.entityGroup.updateMatrix(),c.groups.monolith.add(this.entityGroup),o.reprerender=!0,o.dirtyobjects=!0}}S.light_source=Y;function q(){if(v.key("f1")==1)S.TOGGLE_TOP_DOWN_MODE=!S.TOGGLE_TOP_DOWN_MODE,S.TOGGLE_TOP_DOWN_MODE?o.magiccamerarotation=0:o.magiccamerarotation=o.constantmagiccamerarotation;else if(v.key("f2")==1)S.TOGGLE_RENDER_AXES=!S.TOGGLE_RENDER_AXES;else if(v.key("f3")==1)S.TOGGLE_NORMAL_MAPS=!S.TOGGLE_NORMAL_MAPS;else if(v.key("k")==1)o.wallrotation-=.01;else if(v.key("l")==1)o.wallrotation+=.01;else if(v.key("v")==1)o.magiccamerarotation>0&&(o.magiccamerarotation-=.01);else if(v.key("b")==1)o.magiccamerarotation+=.01;else if(v.key("q")==1)o.hexsize=s.add(o.hexsize,[0,1]);else if(v.key("a")==1)o.hexsize=s.add(o.hexsize,[0,-1]);else if(v.key("1")==1)o.hexsize=s.add(o.hexsize,[-1,0]);else if(v.key("2")==1)o.hexsize=s.add(o.hexsize,[1,0]);else return;ie.purgeRemake()}})(je||(je={}));var X=je;var pe=class extends G.obj{constructor(t){super(o.gobjscount);this.data=t;n(this,"object3d");n(this,"sprite");n(this,"r",0);n(this,"z",0);this.data={name:"a game object",extra:{},...t},this.wpos=s.copy(t._wpos),this.z=t._wpos[2],this.r=t._r||0,this._wtorpos(),this.rpos=s.floor(this.rpos)}update(){this.sprite?.update()}_create(){console.warn(" game object empty create ")}_delete(){this.sprite?.delete(),this.object3d?.delete()}_step(){super._step(),this.sprite?.step(),this.object3d?.step()}};(e=>{let l;(h=>{function t(f,b){return G.helpers.getMatrix(f,b)}h.get_matrix=t;function i(f,b,E){return t(f,b).map(y=>y.filter(g=>E.includes(g.data._type)))}h.sort_matrix=i;function a(f){return["northwest","north","northeast","west","center","east","southwest","south","southeast"].map((E,y)=>f[y].length>0?E:null)}h.get_directions=a})(l=e.helpers||(e.helpers={}))})(pe||(pe={}));var K=pe;var Te;(f=>{f.level=3;let e=!1;f.zooms=[1,.5,.33,.2,.1,.05];function i(){L.addListener("worldetchComponents",h)}f.register=i;function a(){return f.zooms[f.level]}f.scale=a;async function h(){(e&&v.wheel==-1||v.key("f")==1)&&(console.log("app wheel"),f.level=f.level>0?f.level-1:f.level,o.dirtyobjects=!0),(e&&v.wheel==1||v.key("r")==1)&&(console.log("app wheel"),f.level=f.level<f.zooms.length-1?f.level+1:f.level,o.dirtyobjects=!0);let b=c.USE_SCENE3?c.camera3:c.camera,E=f.zooms[f.level];return c.cameraMode=="perspective"?c.camera.position.z=(5-f.level)*40||10:b.scale.set(E,E,E),b.updateMatrix(),b.updateProjectionMatrix(),!1}})(Te||(Te={}));var de=Te;var ke=class{constructor(e){this.data=e;n(this,"gobj");n(this,"matrix");n(this,"mesh");n(this,"geometry");n(this,"material");this.data={spriteSize:o.hexsize,spriteImage:"hex/tile.png",spriteColor:"white",...e},this.data.spriteSize=s.make_uneven(this.data.spriteSize,1),this.gobj=this.data.gobj,this.gobj.sprite=this,o.randomspritecolor&&(this.data.spriteColor=o.sample(["purple","magenta","cyan","wheat","pink","salmon"])),this.matrix=new THREE.Matrix3,this.matrix.setUvTransform(0,0,1,1,0,0,1)}create(){this._create()}delete(){this._delete()}step(){this._step()}_step(){}_delete(){}_create(){let e={}}update(){}};function _t(l,e,t={}){let i=new THREE.MeshLambertMaterial(l);return i.customProgramCacheKey=function(){return"romespritemat"},i.name="romespritemat",i.defines=t,i.onBeforeCompile=function(a){a.uniforms.matrix={value:e.matrix},a.uniforms.bool={value:e.bool},e.masked&&(a.uniforms.tMask={value:c.targetMask.texture},a.uniforms.maskColor={value:e.maskColor},console.log("add tmask")),a.vertexShader=a.vertexShader.replace("#include <common>",`#include <common>
			varying vec2 myPosition;
			uniform mat3 matrix;
			`),a.vertexShader=a.vertexShader.replace("#include <worldpos_vertex>",`#include <worldpos_vertex>
			myPosition = (projectionMatrix * mvPosition).xy / 2.0 + vec2(0.5, 0.5);
			`),a.vertexShader=a.vertexShader.replace("#include <uv_vertex>",`
			#ifdef USE_MAP
				vMapUv = ( matrix * vec3( uv, 1 ) ).xy;
			#endif
			`),a.fragmentShader=a.fragmentShader.replace("#include <map_pars_fragment>",`
			#include <map_pars_fragment>
			/*varying vec2 myPosition;
			uniform sampler2D tMask;
			uniform vec3 maskColor;
			uniform bool uniball;*/
			`),a.fragmentShader=a.fragmentShader.replace("#include <map_fragment>",`
			#include <map_fragment>

			/*#ifdef MASKEDx
				vec4 texelColor = texture2D( tMask, myPosition );
				texelColor.rgb = mix(texelColor.rgb, maskColor, 0.7);
				if (texelColor.a > 0.5)
				diffuseColor.rgb = texelColor.rgb;
			#endif*/
			`)},i}var se=ke;var Re=class extends K{constructor(e){super({name:"a tile",...e}),this.wpos=s.floor(this.wpos),this.data._type="tile"}_create(){new se({gobj:this,spriteSize:o.hexsize}),this.sprite?.create()}},xe=Re;var ae=[0,0],V=[0,0],Ze=[0,0],et=[0,0],tt=[1,2],te=class te{static register(){L.addListener("worldetchComponents",this.step),this.startup()}static async step(){return te.do_the_math(),!1}static get wpos(){return s.copy(ae)}static set wpos(e){ae=e,V=G.project(ae)}static get rpos(){return s.copy(V)}static set rpos(e){V=e,ae=G.unproject(V)}static startup(){this.wpos=[10,1],this.marker=new xe({_wpos:[...ae,0],colorOverride:"purple",lonely:!0}),this.marker.show(),window.panMarker=this.marker}static do_the_math(){this.follow(),this.pan(),this.arrows(),ae=G.unproject(V),this.roundRpos&&(V=s.floor(V)),this.marker.wpos=ae,this.noHalfMeasures&&(this.marker.wpos=s.round(this.marker.wpos)),this.marker._wtorpos(),this.marker.update(),this.set_camera()}static follow(){if(this.follower){let e=this.follower.wpos;e=s.add(e,[.5,.5]),V=G.project(e)}}static arrows(){v.key("arrowright")&&(V[0]+=1*o.scale,o.dirtyobjects=!0),v.key("arrowleft")&&(V[0]-=1*o.scale,o.dirtyobjects=!0),v.key("arrowup")&&(V[1]+=1*o.scale,o.dirtyobjects=!0),v.key("arrowdown")&&(V[1]-=1*o.scale,o.dirtyobjects=!0)}static pan(){if(v.button(1)==1){let a=v.mouse();a[1]=-a[1],Ze=a,et=s.copy(V),this.dragging=!0}if(this.dragging!=!1)if(v.button(1)>=1){o.dirtyobjects=!0;let a=v.mouse();a[1]=-a[1];let h=s.subtract(Ze,a);h=s.divide(h,-1),h=s.mult(h,o.dotsPerInch),h=s.mult(h,de.scale()),h=s.mult(h,tt[0],tt[1]),c.USE_SCENE3&&(h=s.divide(h,2)),h=s.subtract(h,et),V=s.inv(h)}else v.button(1)==-1&&(console.log("release"),this.dragReleaseRoundsToNearestFullPixel&&(V=s.round(V)),this.dragging=!1)}static set_camera(){let e=te.rpos;e=s.make_even(e,1),e[1]=ie.roundToNearest(e[1],o.pancompress*2),c.groups.camera.position.x=e[0],c.groups.camera.position.y=e[1],c.groups.camera.position.z=10,c.groups.camera.updateMatrix(),c.camera.rotation.x=o.magiccamerarotation,c.camera.updateMatrix(),c.camera.updateProjectionMatrix()}static unproject_chunk_grid(e){let t=[0,0],i=G.helpers.getEveryChunk(O.world);for(let a of i);}};n(te,"panCompress",2),n(te,"marker"),n(te,"follower"),n(te,"noHalfMeasures",!1),n(te,"roundRpos",!0),n(te,"dragReleaseRoundsToNearestFullPixel",!1),n(te,"dragging",!1);var Me=te,re=Me;var ne=class{static init(){this.world=o.world=G.init()}static update(){this.world.update(re.wpos)}static repopulate(){}static getObjectsAt(e){let{wpos:t}=e;return this.world.chunkAtWpos(t).objsatwpos(t)}static addGameObject(e){G.add(this.world,e)}static removeGameObject(e){G.remove(e)}static _replace(e){let t=this.getObjectsAt(e);for(let i of t)G.remove(i);G.addDontYetShow(this.world,e)}static addMultiple(e,t){for(let i of e)t===this.merge_mode.merge?this._merge(i):t===this.merge_mode.replace?this._replace(i):t===this.merge_mode.dont&&G.addDontYetShow(this.world,i);for(let i of e)i.chunk?.active&&i.show()}static _merge(e){let t=this.getObjectsAt(e),i=!0;for(let a of t)a.data._type=="tile 3d"&&e.data._type=="tile 3d"&&(i=!1,a.preset=e.preset);i&&G.addDontYetShow(this.world,e)}};n(ne,"world");(e=>{let l;(h=>(h[h.dont=0]="dont",h[h.merge=1]="merge",h[h.replace=2]="replace"))(l=e.merge_mode||(e.merge_mode={}))})(ne||(ne={}));var O=ne;var Se=class extends le{constructor(t){super(t.base);n(this,"points",[]);this._stagger()}_stagger(){this.points=[];let t=0,i=0;for(let a=this.base.min[1];a<this.base.max[1];a++){let h=0,f=0,b=i++%2===1;for(let E=this.base.min[0];E<this.base.max[0];E++){let y=E===this.base.min[0]||E===this.base.max[0]-1||a===this.base.min[1]||a===this.base.max[1]-1,g=h++%2===1,m=g,H=a===this.base.min[1],U=E===this.base.max[0]-1,k=a===this.base.max[1]-1,P=E===this.base.min[0];g&&(f+=1),this.points.push({pos:[E,a-f],isBorder:y,isStaggered:m,isXUneven:g,isYUneven:b,isNorth:k,isEast:P,isSouth:H,isWest:U})}}}_tell_size(){}},we=Se;var He=class{constructor(e){this.gobj=e;n(this,"target");n(this,"shape3d");n(this,"matrix",[[]]);n(this,"directions",[])}search(e){this.matrix=K.helpers.sort_matrix(O.world,this.gobj.wpos,e),this.directions=K.helpers.get_directions(this.matrix)}get_all_objects_at(e){let t=this.directions.indexOf(e);if(t!==-1)return this.matrix[t]}tile_occupied(e){return this.directions.includes(e)}has_matrix(e){return this.directions.includes(e)}index_of_direction(e){return this.directions.indexOf(e)}},be=He;var Pe=class extends K{constructor(t,i="default"){super({name:"a wall 3d",...t});this.preset=i;n(this,"wallAdapter");this.data._type="wall 3d",this.wallAdapter=new be(this)}_create(){new me({gobj:this,shapeSize:[16,8,11],shapeType:"wall",shapePreset:this.preset}),this.wallAdapter.search(["wall 3d"]),this.object3d?.create()}},W=Pe;var Ae;(E=>{function l(){}E.init=l;class e{constructor(g,m){this.scale=m;this._set(g)}_set(g){noise.seed(g)}get_simplex2(g,m){return noise.simplex2(g/this.scale[0],m/this.scale[1])}}function t(){i(),a(),h()}E.repopulate=t;function i(){noise.seed(28);let y=[],g=[100,100],m=new e(28,[10,10]);for(let H=0;H<g[0];H++)for(let U=0;U<g[1];U++){let k=m.get_simplex2(U,H),P="default";if(k<0){k<-.6?P="cobblestone":k<-.3&&(P="stonemixed");let D=new F({_type:"direct",_wpos:[-g[0]/2+U,-g[1]/2+H,0]},P);y.push(D)}}O.addMultiple(y,O.merge_mode.merge)}function a(){let y=[],g=[8,0],m=[5,5],H=new Z(g,s.add(g,m));new we(Z.area(H)).do(k=>{if(k.isBorder){let P=new W({_type:"direct",_wpos:[k.pos[0],k.pos[1],0],extra:{staggerData:k}},"elven"),D=new F({_type:"direct",_wpos:[k.pos[0],k.pos[1],0]},"star");y.push(P),y.push(D)}else{let P=new F({_type:"direct",_wpos:[k.pos[0],k.pos[1],0]},"star");y.push(P)}}),O.addMultiple(y,O.merge_mode.merge)}function h(){let y=[],g=[8,8],m=[5,5],H=new Z(g,s.add(g,m));Z.area(H).do(k=>{if(k.isBorder){let P=new W({_type:"direct",_wpos:[k.pos[0],k.pos[1],0]},"basalt");y.push(P)}else{let P=new F({_type:"direct",_wpos:[k.pos[0],k.pos[1],0]},"water");y.push(P)}}),O.addMultiple(y,O.merge_mode.merge)}function f(){let y=[];for(let k=0;k<100;k++)for(let P=0;P<100;P++){let D="default",B=new F({_type:"direct",_wpos:[-50+P,-50+k,0]},D);y.push(B)}O.addMultiple(y,O.merge_mode.replace)}E.test_fill=f;function b(){noise.seed(29)}E.make_bodies_of_water=b})(Ae||(Ae={}));var Oe=Ae;var Ce;(h=>{h.groundPresets={default:{shapeGroundTexture:"./img/textures/beach.jpg",shapeGroundTextureNormal:"./img/textures/beachnormal.jpg"},stonemixed:{shapeGroundTexture:"./img/textures/stonemixed2.jpg",shapeGroundTextureNormal:"./img/textures/stonemixed2normal.jpg"},cobblestone:{shapeGroundTexture:"./img/textures/cobblestone3.jpg",shapeGroundTextureNormal:"./img/textures/cobblestone3normal.jpg"},water:{shapeGroundTexture:"./img/textures/water.jpg",shapeGroundTextureNormal:"./img/textures/beachnormal.jpg"},star:{shapeGroundTexture:"./img/textures/star.jpg",shapeGroundTextureNormal:"./img/textures/starnormal.jpg",shapeGroundSpecular:"cyan"}},h.shapePresets={default:{shapeTexture:"./img/textures/wall2.jpg",shapeTextureNormal:"./img/textures/wall2normal.jpg"},elven:{shapeTexture:"./img/textures/japanese3.jpg",shapeTextureNormal:"./img/textures/cobblestone2normal.jpg"},basalt:{shapeTexture:"./img/textures/basaltcliffs.jpg",shapeTextureNormal:"./img/textures/basalt.jpg"}};function t(){Oe.init(),a()}h.init=t;function i(){}h.update=i;function a(){Oe.repopulate()}h.repopulate=a})(Ce||(Ce={}));var ce=Ce;var Ge=class{constructor(e){this.data=e;n(this,"gobj");n(this,"shape");n(this,"data_");let t=ce.groundPresets[e.groundPreset],i=ce.shapePresets[e.shapePreset];this.data={...e,...t,...i},this.gobj=this.data.gobj,this.gobj.object3d=this}delete(){this.shape?.delete()}create(){this.shape=X.shapeMaker(this.data.shapeType,this.data),this.shape?.create()}step(){this.shape?.step()}},me=Ge;var Ne=class extends K{constructor(t,i="default"){super({name:"a tile 3d",...t});this.preset=i;this.data._type="tile 3d"}_create(){new me({gobj:this,shapeSize:[1,1,1],shapeType:"hex",groundPreset:this.preset}),this.object3d?.create()}},F=Ne;var De=class{static register(){L.addListener("worldetchComponents",this.step),this.startup()}static async step(){return vt(),!1}static startup(){}};function vt(){document.querySelector("worldetch-stats").innerHTML=`
		worldetch - monolith git branch (debug screen)
		<br />DOTS_PER_INCH_CORRECTED_RENDER_TARGET: ${c.DOTS_PER_INCH_CORRECTED_RENDER_TARGET}
		<br />ROUND_UP_DOTS_PER_INCH: ${c.ROUND_UP_DOTS_PER_INCH}
		<br />USE_SCENE3: ${c.USE_SCENE3}
		<br />DITHERING (d): ${c.dithering}
		<br />--
		<br />TOGGLE_TOP_DOWN_MODE (f1): ${X.TOGGLE_TOP_DOWN_MODE}
		<br />TOGGLE_RENDER_AXES (f2): ${X.TOGGLE_RENDER_AXES}
		<br />TOGGLE_NORMAL_MAPS (f3): ${X.TOGGLE_NORMAL_MAPS}
		<br />--
		<br />"globs"
		<br />&#9;randomspritecolor (h): ${o.randomspritecolor}
		<br />magiccamerarotation (v, b): ${o.magiccamerarotation}
		<br />wallrotation (v, b): ${o.wallrotation}
		<br />pancompress (v, b): ${o.pancompress}
		<br />--
		<br />camera rotation x (v, b): ${o.magiccamerarotation}
		<br />color correction (z): ${c.compression}
		<br />render scale (-, =): ${o.scale}
		<br />zoom scale (r, f): ${de.scale()}
		<br />grid (t, g): ${O.world.grid.spread} / ${O.world.grid.outside}
		<br />hexscalar ([, ]): ${X.hexscalar}
		<br />--
		<br />fps: ${o.fps?.toFixed(2)} ${o.delta?.toFixed(3)}
		<br />reprerender: ${o.reprerender}
		<br />dirtyObjects: ${o.dirtyobjects}
		<br />hex size (q, a): ${s.to_string_fixed(o.hexsize)}
		<!--<br />cameraMode: ${c.cameraMode}-->
		<br />chunk span size: ${G.chunk_span} x ${G.chunk_span}
		<br />gobjs: ${o.gobjscount[0]} / ${o.gobjscount[1]}
		<br />chunks: ${G.numbers.chunks[0]} / ${G.numbers.chunks[1]}
		<br />pan wpos, rpos: ${s.to_string_fixed(re.wpos)} (${s.to_string_fixed(re.rpos)})
		`}var rt=De;var ze;(t=>{function l(){console.log(" game/romanlike ")}t.init=l;function e(){console.log(" game/romanlike ")}t.register=e})(ze||(ze={}));var ot=ze;var Fe=class extends K{constructor(t){super({name:"a light",...t});n(this,"light_source");this.data._type="light"}_create(){console.log(" create light "),this.light_source=new X.light_source({gobj:this,radiance:200}),this.light_source.create(),new se({gobj:this,spriteImage:"hex/post.png",spriteSize:[o.hexsize[0],30],bottomSort:!0}),this.sprite?.create()}_delete(){super._delete(),this.light_source?.delete()}_step(){super._step(),this.light_source.step()}},ue=Fe;var Le;(y=>{function l(g){return g[Math.floor(Math.random()*g.length)]}y.sample=l;function e(g,m,H){return g>H?H:g<m?m:g}y.clamp=e;function t(g,m){return Math.round(g/m)*m}y.roundToNearest=t;async function i(){console.log(" init "),o.rome=y,o.reprerender=!0,o.dirtyobjects=!0,o.randomspritecolor=!1,o.scale=1,o.constantmagiccamerarotation=.962,o.magiccamerarotation=o.constantmagiccamerarotation,o.hexsize=[17,9],o.hexsize=[17,15],o.pancompress=2,o.camerarpos=[0,0],o.gobjscount=[0,0],o.sample=y.sample,await a(),await c.init(),await X.init(),ot.init(),O.init(),ce.init(),v,h(),rt.register(),de.register(),re.register()}y.init=i;async function a(){await c.preloadTextureAsync("./img/hex/tile.png","nearest"),await c.preloadTextureAsync("./img/hex/wall.png","nearest"),await c.preloadTextureAsync("./img/hex/post.png","nearest")}function h(){let g=[],m=H=>g.push(H);m(new F({colorOverride:"pink",_wpos:[-1,0,0]},"cobblestone")),m(new F({colorOverride:"salmon",_wpos:[-1,-1,0]})),m(new F({colorOverride:"cyan",_wpos:[0,-1,0]})),m(new F({colorOverride:"yellow",_wpos:[-1,1,0]})),m(new F({colorOverride:"yellow",_wpos:[0,1,0]})),m(new F({colorOverride:"salmon",_wpos:[0,2,0]})),m(new F({colorOverride:"yellow",_wpos:[0,3,0]})),m(new F({colorOverride:"orange",_wpos:[0,4,0]})),m(new F({colorOverride:"red",_wpos:[0,5,0]})),m(new F({colorOverride:"blue",_wpos:[0,6,0]})),m(new F({colorOverride:"wheat",_wpos:[0,7,0]})),m(new F({colorOverride:"lavender",_wpos:[0,8,0]})),m(new F({colorOverride:"cyan",_wpos:[0,9,0]})),m(new W({colorOverride:"green",_wpos:[2,1,0]})),m(new W({colorOverride:"lavender",_wpos:[2,3,0]})),m(new W({colorOverride:"magenta",_wpos:[3,1,0]})),m(new W({colorOverride:"pink",_wpos:[3,2,0]})),m(new W({colorOverride:"blue",_wpos:[3,3,0]})),m(new W({colorOverride:"red",_wpos:[4,3,0]})),m(new W({colorOverride:"purple",_wpos:[5,3,0]})),m(new ue({_wpos:[2,2,0]})),m(new ue({_wpos:[-11,6,0]})),m(new ue({_wpos:[9,2,0]})),m(new W({colorOverride:"magenta",_wpos:[1,2,0]})),m(new W({colorOverride:"pink",_wpos:[1,3,0]})),m(new W({colorOverride:"blue",_wpos:[1,4,0]})),m(new W({colorOverride:"red",_wpos:[1,5,0]})),m(new W({colorOverride:"purple",_wpos:[1,6,0]})),m(new W({colorOverride:"purple",_wpos:[1,7,0]})),m(new W({colorOverride:"purple",_wpos:[1,8,0]})),O.addMultiple(g,O.merge_mode.merge)}y.makeTestingChamber=h;function f(){console.warn(" purgeRemake ");let g=G.helpers.getEveryChunk(O.world);for(let m of g)m.nuke();o.reprerender=!0,o.dirtyobjects=!0,X.purge(),c.purge(),O.init(),O.repopulate(),ce.repopulate(),h()}y.purgeRemake=f;function b(){L.emit("worldetchComponents",1),L.emit("worldetchStep",0),E(),O.update(),ce.update(),o.reprerender=!1}y.step=b;function E(){if(v.key("h")==1&&(o.randomspritecolor=!o.randomspritecolor,f()),v.key("-")==1&&(o.scale>1&&(o.scale-=1),re.rpos=s.mult(s.project(re.wpos),o.scale),console.log(o.scale),f()),v.key("=")==1&&(o.scale+=1,re.rpos=s.mult(s.project(re.wpos),o.scale),console.log(o.scale),f()),v.key("c")==1){let g=G.helpers.getEveryChunk(O.world);console.log("chunks",g)}v.key("a")==1&&console.log("arrays",O.world.arrays),v.key("t")==1&&(O.world.grid.shrink(),o.reprerender=!0,o.dirtyobjects=!0),v.key("g")==1&&(O.world.grid.grow(),o.reprerender=!0,o.dirtyobjects=!0),v.key("[")==1&&(X.hexscalar-=.1,console.log(X.hexscalar),f()),v.key("]")==1&&(X.hexscalar+=.1,console.log(X.hexscalar),f())}})(Le||(Le={}));var ie=Le;var Ue;(_=>{window.App=_;let l;(j=>(j[j.OFF=0]="OFF",j[j.PRESS=1]="PRESS",j[j.WAIT=2]="WAIT",j[j.AGAIN=3]="AGAIN",j[j.UP=4]="UP"))(l=_.KEY||(_.KEY={}));let e;(S=>(S[S.UP=-1]="UP",S[S.OFF=0]="OFF",S[S.DOWN=1]="DOWN",S[S.STILL=2]="STILL"))(e=_.MOUSE||(_.MOUSE={})),_.feed="abc";var a={},h={},f=[0,0];_.wheel=0,_.mobile=!1;function y(p){if(!p.key)return;let M=p.key.toLowerCase();p.type=="keydown"?a[M]=a[M]?3:1:p.type=="keyup"&&(a[M]=4),(p.keyCode==112||p.keyCode==113||p.keyCode==114||p.keyCode==115||p.keyCode==116)&&p.preventDefault()}_.onkeys=y;function g(p){return a[p]}_.key=g;function m(p){return h[p]}_.button=m;function H(){return[...f]}_.mouse=H;async function U(p){console.log("boot"),_.mobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);function M(R){f[0]=R.clientX,f[1]=R.clientY,L.emit("onmousemove",!1)}function Y(R){if(h[R.button]=1,R.button==1)return!1;L.emit("onmousedown",!1)}function q(R){h[R.button]=-1,L.emit("onmouseup",!1)}function S(R){_.wheel=R.deltaY<0?1:-1}let j=[0,0];function u(R){j=[R.pageX,R.pageY],f[0]=R.pageX,f[1]=R.pageY,L.emit("onmousedown",!1)}function d(R){return f[0]=R.pageX,f[1]=R.pageY,h[0]=1,R.preventDefault(),L.emit("onmousemove",!1),!1}function T(R){let N=[R.pageX,R.pageY];h[0]=-1,L.emit("onmouseup",!1),s.equals(N,j)}function I(R){document.querySelectorAll(".stats")[0].innerHTML=R}_.mobile?(document.ontouchstart=u,document.ontouchmove=d,document.ontouchend=T):(document.onkeydown=document.onkeyup=y,document.onmousemove=M,document.onmousedown=Y,document.onmouseup=q,document.onwheel=S),await ie.init();let Q=z(C)}_.boot=U;function k(){for(let p in a)a[p]==1?a[p]=2:a[p]==4&&(a[p]=0)}function P(){for(let p of[0,1,2])h[p]==1?h[p]=2:h[p]==-1&&(h[p]=0)}let D=(()=>{let p=(performance||Date).now(),M=p,Y=0;return function(){Y++;var q=(performance||Date).now();if(q>=M+1e3){let S=Y*1e3/(q-M);M=q,Y=0,o.fps=S}}})(),B=(()=>{let p=0;return function(){let M=(performance||Date).now(),Y=(M-p)/1e3;p=M,o.delta=Y}})();async function C(){D(),B(),await ie.step(),await L.emit("animationFrame",1),c.render(),_.wheel=0,k(),P()}_.base_loop=C;async function z(p){let M=!0;do await x(),await p();while(M);return{runs:()=>M,stop:()=>M=!1}}_.trick_animation_frame=z;async function x(){return new Promise(requestAnimationFrame)}function w(p,M){let Y=document.querySelector(p);Y.innerHTML=M}_.sethtml=w})(Ue||(Ue={}));var v=Ue;var yt=`
float luma(vec3 color) {
	return dot(color, vec3(0.299, 0.587, 0.114));
	//return dot(color, vec3(0.5, 0.5, 0.5));
}

float dither8x8(vec2 position, float brightness) {
	int x = int(mod(position.x, 8.0));
	int y = int(mod(position.y, 8.0));
	int index = x + y * 8;
	float limit = 0.0;
  
	if (x < 8) {
	  if (index == 0) limit = 0.015625;
	  if (index == 1) limit = 0.515625;
	  if (index == 2) limit = 0.140625;
	  if (index == 3) limit = 0.640625;
	  if (index == 4) limit = 0.046875;
	  if (index == 5) limit = 0.546875;
	  if (index == 6) limit = 0.171875;
	  if (index == 7) limit = 0.671875;
	  if (index == 8) limit = 0.765625;
	  if (index == 9) limit = 0.265625;
	  if (index == 10) limit = 0.890625;
	  if (index == 11) limit = 0.390625;
	  if (index == 12) limit = 0.796875;
	  if (index == 13) limit = 0.296875;
	  if (index == 14) limit = 0.921875;
	  if (index == 15) limit = 0.421875;
	  if (index == 16) limit = 0.203125;
	  if (index == 17) limit = 0.703125;
	  if (index == 18) limit = 0.078125;
	  if (index == 19) limit = 0.578125;
	  if (index == 20) limit = 0.234375;
	  if (index == 21) limit = 0.734375;
	  if (index == 22) limit = 0.109375;
	  if (index == 23) limit = 0.609375;
	  if (index == 24) limit = 0.953125;
	  if (index == 25) limit = 0.453125;
	  if (index == 26) limit = 0.828125;
	  if (index == 27) limit = 0.328125;
	  if (index == 28) limit = 0.984375;
	  if (index == 29) limit = 0.484375;
	  if (index == 30) limit = 0.859375;
	  if (index == 31) limit = 0.359375;
	  if (index == 32) limit = 0.0625;
	  if (index == 33) limit = 0.5625;
	  if (index == 34) limit = 0.1875;
	  if (index == 35) limit = 0.6875;
	  if (index == 36) limit = 0.03125;
	  if (index == 37) limit = 0.53125;
	  if (index == 38) limit = 0.15625;
	  if (index == 39) limit = 0.65625;
	  if (index == 40) limit = 0.8125;
	  if (index == 41) limit = 0.3125;
	  if (index == 42) limit = 0.9375;
	  if (index == 43) limit = 0.4375;
	  if (index == 44) limit = 0.78125;
	  if (index == 45) limit = 0.28125;
	  if (index == 46) limit = 0.90625;
	  if (index == 47) limit = 0.40625;
	  if (index == 48) limit = 0.25;
	  if (index == 49) limit = 0.75;
	  if (index == 50) limit = 0.125;
	  if (index == 51) limit = 0.625;
	  if (index == 52) limit = 0.21875;
	  if (index == 53) limit = 0.71875;
	  if (index == 54) limit = 0.09375;
	  if (index == 55) limit = 0.59375;
	  if (index == 56) limit = 1.0;
	  if (index == 57) limit = 0.5;
	  if (index == 58) limit = 0.875;
	  if (index == 59) limit = 0.375;
	  if (index == 60) limit = 0.96875;
	  if (index == 61) limit = 0.46875;
	  if (index == 62) limit = 0.84375;
	  if (index == 63) limit = 0.34375;
	}
  
	return brightness < limit ? 0.0 : 1.0;
  }

float dither4x4(vec2 position, float brightness) {
	int x = int(mod(position.x, 4.0));
	int y = int(mod(position.y, 4.0));
	int index = x + y * 4;
	float limit = 0.0;

	if (x < 8) {
		if (index == 0) limit = 0.0625;
		if (index == 1) limit = 0.5625;
		if (index == 2) limit = 0.1875;
		if (index == 3) limit = 0.6875;
		if (index == 4) limit = 0.8125;
		if (index == 5) limit = 0.3125;
		if (index == 6) limit = 0.9375;
		if (index == 7) limit = 0.4375;
		if (index == 8) limit = 0.25;
		if (index == 9) limit = 0.75;
		if (index == 10) limit = 0.125;
		if (index == 11) limit = 0.625;
		if (index == 12) limit = 1.0;
		if (index == 13) limit = 0.5;
		if (index == 14) limit = 0.875;
		if (index == 15) limit = 0.375;
	}

	return brightness < limit ? 0.0 : 1.0;
}
  
vec3 dither4x4(vec2 position, vec3 color) {
	return color * dither4x4(position, luma(color));
}

vec3 dither8x8(vec2 position, vec3 color) {
	return color * dither8x8(position, luma(color));
}

float saturation = 2.0;

uniform int compression;
uniform int dithering;

// 24 is best
// 32 is nice
// 48 is mild
float factor = 24.0;

void mainImage(const in vec4 inputColor, const in vec2 uv, out vec4 outputColor) {

	outputColor = vec4(floor(inputColor.rgb * factor + 0.5) / factor, inputColor.a);

}

// Todo add effect
varying vec2 vUv;
uniform sampler2D tDiffuse;
void main() {
	vec4 clr = texture2D( tDiffuse, vUv );
	// clr.rgb = mix(clr.rgb, vec3(1.0, 0, 0), 0.5);
	
	if (compression == 1) {
		mainImage(clr, vUv, clr);
	}

	/*vec3 original_color = clr.rgb;
	vec3 lumaWeights = vec3(.25,.50,.25);
	vec3 grey = vec3(dot(lumaWeights,original_color));
	clr = vec4(grey + saturation * (original_color - grey), 1.0);*/
	
	gl_FragColor = clr;
	if (dithering == 1) {
		gl_FragColor.rgb = dither4x4(gl_FragCoord.xy, gl_FragColor.rgb);
	}
}`,Et=`
varying vec2 vUv;
uniform sampler2D tDiffuse;
void main() {
	vec4 clr = texture2D( tDiffuse, vUv );
	// clr.rgb = mix(clr.rgb, vec3(1.0, 0, 0), 0.5);
	gl_FragColor = clr;
}`,it=`
varying vec2 vUv;
void main() {
	vUv = uv;
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}`,Ie;(r=>{r.cameraMode="ortho",r.DOTS_PER_INCH_CORRECTED_RENDER_TARGET=!0,r.ROUND_UP_DOTS_PER_INCH=!0,r.USE_SCENE3=!0,r.dotsPerInch=1,r.dithering=!0,r.compression=!1;let b;(qe=>{})(b=r.groups||(r.groups={}));function Y(){v.key("z")==1&&(r.material2.uniforms.compression.value=r.compression=!r.compression),v.key("d")==1&&(r.material2.uniforms.dithering.value=r.dithering=!r.dithering),o.dirtyobjects&&(r.renderer.setRenderTarget(r.target),r.renderer.clear(),r.renderer.render(r.scene,r.camera)),r.camera2.scale.set(1/2,1/2,1/2),r.camera2.updateMatrix(),r.renderer.setRenderTarget(r.target2),r.renderer.clear(),r.renderer.render(r.scene2,r.camera2),r.renderer.setRenderTarget(null),r.renderer.clear(),r.renderer.render(r.scene3,r.camera3),o.dirtyobjects=!1}r.render=Y;function S(){T()}r.purge=S;function j(){console.log("pipeline init"),o.dirtyobjects=!0,THREE.ColorManagement.enabled=!1,THREE.Object3D.DEFAULT_MATRIX_AUTO_UPDATE=!0,THREE.Object3D.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0,b.camera=new THREE.Group,b.sprites=new THREE.Group,b.sprites.visible=!1,b.sprites.frustumCulled=!1,b.monolith=new THREE.Group,r.scene=new THREE.Scene,r.scene.frustumCulled=!1,r.scene.add(b.camera),r.scene.add(b.sprites),r.scene.add(b.monolith),r.scene.background=new THREE.Color("#333"),r.ambientLight=new THREE.AmbientLight("white",Math.PI/2),r.scene.add(r.ambientLight),r.scene2=new THREE.Scene,r.scene2.frustumCulled=!1,r.scene2.background=new THREE.Color("green"),r.scene2.add(new THREE.AmbientLight("white",Math.PI/1)),r.scene3=new THREE.Scene,r.scene3.frustumCulled=!1,r.scene3.background=new THREE.Color("purple"),r.scene3.add(new THREE.AmbientLight("white",Math.PI/1)),r.sceneMask=new THREE.Scene,r.sceneMask.add(new THREE.AmbientLight("white",Math.PI/1)),r.dotsPerInch=window.devicePixelRatio,r.dotsPerInch=Math.ceil(r.dotsPerInch),o.dotsPerInch=r.dotsPerInch,r.target=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,colorSpace:THREE.NoColorSpace,generateMipmaps:!1}),r.target2=r.target.clone(),r.targetMask=r.target.clone(),r.renderer=new THREE.WebGLRenderer({antialias:!1}),o.renderer=r.renderer,r.renderer.setPixelRatio(r.dotsPerInch),r.renderer.setSize(100,100),r.renderer.setClearColor(16777215,0),r.renderer.autoClear=!0,r.renderer.toneMapping=THREE.NoToneMapping,document.body.appendChild(r.renderer.domElement),window.addEventListener("resize",T,!1),window.pipeline=r.renderer,T()}r.init=j,r.screenSize=[0,0],r.targetSize=[0,0];function T(){for(r.screenSize=[window.innerWidth,window.innerHeight],r.screenSize=s.floor(r.screenSize),r.targetSize=s.copy(r.screenSize),r.targetSize=s.mult(r.screenSize,r.dotsPerInch),r.targetSize=s.floor(r.targetSize),r.renderer.setSize(r.screenSize[0],r.screenSize[1]),console.log(`
		window inner ${s.to_string(r.screenSize)}

		      new is ${s.to_string(r.targetSize)}`),r.target.setSize(r.targetSize[0],r.targetSize[1]),r.targetMask.setSize(r.targetSize[0],r.targetSize[1]),r.target2.setSize(r.targetSize[0],r.targetSize[1]),r.plane?.dispose(),r.plane=new THREE.PlaneGeometry(r.targetSize[0],r.targetSize[1]),o.dirtyobjects=!0,r.material2?.dispose(),r.material2=new THREE.ShaderMaterial({uniforms:{tDiffuse:{value:r.target.texture},compression:{value:r.compression},dithering:{value:r.dithering}},vertexShader:it,fragmentShader:yt,depthTest:!1,depthWrite:!1}),r.quad2=new THREE.Mesh(r.plane,r.material2);r.scene2.children.length>0;)r.scene2.remove(r.scene2.children[0]);for(r.scene2.add(r.quad2),r.material3?.dispose(),r.material3=new THREE.ShaderMaterial({uniforms:{tDiffuse:{value:r.target2.texture}},vertexShader:it,fragmentShader:Et,depthTest:!1,depthWrite:!1}),r.quad3=new THREE.Mesh(r.plane,r.material3);r.scene3.children.length>0;)r.scene3.remove(r.scene3.children[0]);for(r.scene3.add(r.quad3);b.camera.children.length>0;)b.camera.remove(b.camera.children[0]);r.cameraMode=="perspective"?(r.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),r.camera.position.z=200,r.camera.updateMatrix(),b.camera.rotation.x=Math.PI/12,b.camera.add(r.camera),b.camera.updateMatrix()):(r.camera=ee(r.targetSize[0],r.targetSize[1]),b.camera.add(r.camera),b.camera.add(new THREE.AxesHelper(20)),r.camera.rotation.x=o.magiccamerarotation),r.camera.updateMatrix(),r.camera.updateProjectionMatrix(),r.camera2=ee(r.targetSize[0],r.targetSize[1]),r.camera2.updateProjectionMatrix(),r.camera3=ee(r.targetSize[0],r.targetSize[1]),r.camera3.updateProjectionMatrix()}let I=[];async function Q(A,$="nearest"){let J=await new THREE.TextureLoader().loadAsync(A+`?v=${v.feed}`);I[A]=J,J.generateMipmaps=!1,J.center.set(0,1),J.wrapS=J.wrapT=THREE.RepeatWrapping,$==="linear"?(J.magFilter=THREE.LinearFilter,J.minFilter=THREE.LinearFilter):$==="nearest"&&(J.magFilter=THREE.NearestFilter,J.minFilter=THREE.NearestFilter)}r.preloadTextureAsync=Q;function R(A){return I[A]}r.getTexture=R;function N(A,$){return new THREE.WebGLRenderTarget(A,$,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,colorSpace:THREE.NoColorSpace,generateMipmaps:!1})}r.makeRenderTarget=N;function ee(A,$){let J=new THREE.OrthographicCamera(A/-2,A/2,$/2,$/-2,-500,500);return J.updateProjectionMatrix(),J}r.makeOrthographicCamera=ee;function he(A){for(;A.children.length>0;)A.remove(A.children[0])}r.utilEraseChildren=he})(Ie||(Ie={}));var c=Ie;var $e=class{constructor(){n(this,"_active",!1)}get active(){return this._active}on(){return this.active?!0:(this._active=!0,!1)}off(){return this.active?(this._active=!1,!1):!0}},We=$e;var Be;(B=>{B.chunk_span=3;function a(){return console.log("init"),new B.world(10)}B.init=a;function h(){}B.register=h;function f(z){return s.mult(s.project(z),o.scale)}B.project=f;function b(z){return s.divide(s.unproject(z),o.scale)}B.unproject=b;function E(z,x){x&&z.chunkAtWpos(x.wpos).add(x)}B.add=E;function y(z,x){x&&z.chunkAtWpos(x.wpos).add(x,!1)}B.addDontYetShow=y;function g(z){z.chunk?.remove(z)}B.remove=g;class m{constructor(x){n(this,"grid");n(this,"arrays",[]);this.grid=new U(this,2,2)}update(x){this.grid.cpos=B.world.wtocpos(x),this.grid.ons(),this.grid.offs(),this.grid.runs()}lookup(x){return this.arrays[x[1]]==null&&(this.arrays[x[1]]=[]),this.arrays[x[1]][x[0]]}at(x){return this.lookup(x)||this._make(x)}chunkAtWpos(x){return this.at(m.wtocpos(x))}_make(x){let w=this.lookup(x);return w||(this.arrays[x[1]][x[0]]=new H(x,this))}static wtocpos(x){return s.floor(s.divide(x,3))}}B.world=m;class H extends We{constructor(w,_){super();this.cpos=w;this.world=_;n(this,"group");n(this,"color");n(this,"fog_of_war",!1);n(this,"small");n(this,"objs",[]);let p=s.mult(this.cpos,3),M=s.add(p,[2,2]);this.small=new Z(M,p),this.group=new THREE.Group,this.group.frustumCulled=!1,this.group.matrixAutoUpdate=!1,D.chunks[1]++,_.arrays[this.cpos[1]][this.cpos[0]]=this,oe.emit("chunkCreate",this)}nuke(){D.chunks[1]--,this.hide();for(let w of this.objs)w.finalize();this.objs.splice(0,this.objs.length),this.objs.length=0}add(w,_=!0){this.objs.includes(w)==!1&&(this.objs.push(w),w.chunk=this,this.active&&_&&w.show())}remove(w){let _=this.objs.indexOf(w);if(_>-1)return w.chunk=null,!!this.objs.splice(_,1).length}objsatwpos(w){let _=[];for(let p of this.objs)s.equals(s.round(w),s.round(p.wpos))&&_.push(p);return _}static swap(w){let _=w.chunk,p=_.world.chunkAtWpos(w.wpos);_!=p&&(_.remove(w),p.add(w),p.active||w.hide())}tick(){oe.emit("chunkTick",this)}show(){if(!this.on()){D.chunks[0]++;for(let w of this.objs)w.show();c.scene.add(this.group),oe.emit("chunkShow",this)}}hide(){if(!this.off()){D.chunks[0]--;for(let w of this.objs)w.hide();c.scene.remove(this.group),oe.emit("chunkHide",this)}}dist(){return s.distsimple(this.cpos,this.world.grid.cpos)}grayscale(){this.color="gray"}}B.chunk=H;class U{constructor(x,w,_){this.world=x;this.spread=w;this.outside=_;n(this,"cpos",[0,0]);n(this,"shown",[]);n(this,"visibleObjs",[]);this.outside<this.spread&&(console.warn(" outside less than spread ",this.spread,this.outside),this.outside=this.spread)}grow(){this.spread++,this.outside++}shrink(){this.spread--,this.outside--}visible(x){return x.dist()<this.spread}ons(){for(let x=-this.spread;x<this.spread+1;x++)for(let w=-this.spread;w<this.spread+1;w++){let _=s.add(this.cpos,[w,x]),p=this.world.lookup(_);p&&(p.active||(this.shown.push(p),p.show()))}}offs(){this.visibleObjs=[];let x=this.shown.length;for(;x--;){let w;w=this.shown[x],w.dist()>this.outside?(w.hide(),this.shown.splice(x,1)):(w.tick(),this.visibleObjs=this.visibleObjs.concat(w.objs))}}runs(){for(let x of this.shown)for(let w of x.objs)w.step()}}B.grid=U;let C=class C extends We{constructor(w=D.objs){super();this.counts=w;n(this,"id",-1);n(this,"wpos",[0,0]);n(this,"rpos",[0,0]);n(this,"size",[64,64]);n(this,"chunk");n(this,"bound");n(this,"expand",.5);this.counts[1]++,this.id=C.ids++}finalize(){this.counts[1]--,this.hide()}show(){this.on()||(this.counts[0]++,this._create())}hide(){this.off()||(this.counts[0]--,this._delete())}rebound(){this.bound=new Z([-this.expand,-this.expand],[this.expand,this.expand]),this.bound.translate(this.wpos)}_wtorpos(){this.rpos=B.project(this.wpos),this.rpos=s.floor(this.rpos)}_rtospos(){return this._wtorpos(),s.copy(this.rpos)}step(){this._step()}_create(){console.warn(" empty create ")}_delete(){}_step(){this._wtorpos(),this.rebound()}};n(C,"ids",0);let k=C;B.obj=C;let P;(w=>{function z(_){let p=[];for(let M in _.arrays)for(let Y in _.arrays[M])p.push(_.arrays[M][Y]);return p}w.getEveryChunk=z;function x(_,p){let M=[[-1,1],[0,1],[1,1],[-1,0],[0,0],[1,0],[-1,-1],[0,-1],[1,-1]],Y=[];return M.forEach((q,S)=>{q=s.add(q,p),Y[S]=_.chunkAtWpos(q).objsatwpos(q)}),Y}w.getMatrix=x})(P=B.helpers||(B.helpers={}));let D;(M=>(M.chunks=[0,0],M.objs=[0,0],M.sprites=[0,0],M.tiles=[0,0],M.walls=[0,0]))(D=B.numbers||(B.numbers={}))})(Be||(Be={}));var G=Be;var Xe=class extends K{constructor(e){super({name:"a wall",...e}),this.data._type="wall"}_create(){new se({gobj:this,bottomSort:!0,spriteSize:[o.hexsize[0],21],spriteImage:"hex/wall.png",spriteColor:"blue"}),this.sprite?.create()}},st=Xe;function jt(l){let e;switch(l._type){case"direct":console.warn(" unset type passed to factory ");break;case"tile":e=new xe(l);break;case"wall":e=new st(l);break}return e}var at=jt;var Tt={loom:G,direction_adapter:be,object3d:me,renderer:c,sprite:se,staggered_area:we,tileform:X,WorldManager:O,objects:{game_object_factory:at,game_object:K,light:ue,tile3d:F,wall3d:W},dep:{aabb2:Z,area2:le,glob:o,hooks:L,pts:s}};return bt(kt);})();
